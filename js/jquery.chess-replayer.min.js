/*
 Chess Replayer 1.1.5
 Copyright (c) 2012 Andrew Hoy
 http://github.com/andrewphoy/chess-replayer
 MIT License
*/
(function(){var h=!0,i=null,j=!1,l=jQuery;
function p(a,b,c,d,e,f,g){this.I=a;this.La=b;this.move=c;this.m=d;this.ua=e;this.da=f;this.S=g;this.j=[];this.children=[];this.ea=function(a){"$"==a.charAt(0)&&(a=a.substring(1));switch(parseInt(a,10)){case 1:return"!";case 2:return"?";case 3:return"!!";case 4:return"??";case 5:return"!?";case 6:return"?!";case 7:case 8:return"&#x25a1;";case 10:return"=";case 13:return"&infin;";case 14:return"&#x2a72;";case 15:return"&#x2a71;";case 16:return"&plusmn;";case 17:return"&#8723;";case 18:return"&#43;&minus;";
case 19:return"&minus;&#43;";case 22:case 23:return"&#x2a00;";case 32:case 33:return"&#x27F3;";case 36:case 37:return"&#x2192;";case 40:case 41:return"&#x2191;";case 132:case 133:return"&#x21c6;";case 140:return"&#x2206;";case 142:return"&#x2313;";case 145:return"RR";case 146:return"N";case 239:return"&#x21d4;";case 240:return"&#x21d7;";case 242:return"&#x27eb;";case 243:return"&#x27ea;";case 244:return"&#x2715;";case 245:return"&#x22a5;";default:return""}};this.o=function(a){var b="";a&&(b+=this.La+
" ");b+=this.move;if(this.da)for(var a=this.da.split(" "),b=b+this.ea(a[0]),c=1;c<a.length;c++)b+=" "+this.ea(a[c]);return b};this.toString=function(){return this.o(j)};this.X=function(a,b,c){c=c||1==this.S%2||0==this.m;a=a="<span id='"+a+"move"+this.I+"' class='move move"+b+"'>";return a+=this.o(c)+"</span>"}}
function q(a,b){this.c=a;this.c.id||(this.c.id="cr"+Math.random().toString(36).substring(5));this.i=l(a);this.options=b;this.Y=this.i.data("replayer-options");this.a={headers:[],result:"",e:0,g:1,z:"",C:0,position:[],U:-1,K:-1,Q:j,f:[]};this.d={n:j,Z:0,k:0,direction:-1}}
q.prototype={D:{fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",size:"small",lightColor:"#CCCCCC",darkColor:"#999999",startPly:j,boardOnly:j,hideControls:j,hideAnnotations:j,showAnnotations:j,scrollOnEnd:j,startFlipped:j},size:{v:45,u:60,t:80},shift:{left:{v:13,u:21,t:31},top:{v:12,u:20,t:28}},h:{ma:"((?:\\s*\\$\\d+)*)(\\s*\\{[^\\}]*\\})*",za:/(1-0|0-1|1\/2-1\/2|\*)$/g,va:/\{([^}]*?)(\()(.*?)\}/g,wa:/\{([^}]*?)(\))(.*?)\}/g,ra:/^O-O/,sa:/^O-O-O/,ja:/^([KQBNR])/,Pa:/(.*)([a-h])([1-8])/,
Qa:/^[KQBNR]([a-h])?([1-8])?x?[a-h][1-8]/,ha:/^([a-h])([1-8])/,ga:/^([a-h])x([a-h])([1-8])/,ia:/=([QBNR])/},w:{Va:[-16,-1,1,16],Ga:[-33,-31,-18,-14,14,18,31,33],qa:[-17,-15,15,17],Ua:[-17,-15,15,17,-16,-1,1,16],Fa:[-17,-16,-15,-1,1,15,16,17]},Ca:function(){this.T=l.extend({},this.options,this.Y);this.b=l.extend({},this.D,this.options,this.Y);this.ta();this.Na();this.Sa();this.Ta();this.pa();this.Ka();this.oa()},oa:function(){var a=this;this.i.keydown(function(b){return 39==b.which?(a.H(j),j):37==
b.which?(a.A(j),j):40==b.which&&a.d.n?(b.preventDefault(),a.Ia(),j):38==b.which&&a.d.n?(b.preventDefault(),a.Ja(),j):70==b.which?(a.N(),j):83==b.which||36==b.which||72==b.which?(a.ba(),j):69==b.which||35==b.which?(b.ctrlKey?a.G():a.$(),j):27==b.which?(a.L(),j):h});l(".board,.moves",this.c).bind("mousewheel DOMMouseScroll",function(b){var c=j;(c=0<(-b.originalEvent.detail||b.wheelDelta||b.originalEvent.wheelDelta)?a.A(j):a.H(j))&&b.preventDefault();return!c&&a.b.scrollOnEnd});l(".next",this.c).click(function(){a.H(j);
return j});l(".back",this.c).click(function(){a.A(j);return j});l(".start",this.c).click(function(){a.ba();return j});l(".flip",this.c).click(function(){a.N();return j});l(".end",this.c).click(function(){a.G();return j});l(".move",this.c).click(function(){var b=this.id.substring(a.c.id.length+4);"-end"==b?a.G():a.ca(b);return j})},ta:function(){this.b.size=this.b.size.toLowerCase();"small"!=this.b.size&&"large"!=this.b.size&&(this.b.size="medium")},O:function(){return"small"==this.b.size?this.shift.left.v:
"large"==this.b.size?this.shift.left.t:this.shift.left.u},P:function(){return"small"==this.b.size?this.shift.top.v:"large"==this.b.size?this.shift.top.t:this.shift.top.u},s:function(){return this.i.find(".board")},V:function(){return this.i.find(".controls")},l:function(){return this.i.find(".moves")},fa:function(){return this.i.find(".notes")},Wa:function(a){!this.b.boardOnly&&!this.b.hideAnnotations&&this.fa().html(a)},q:function(){return"small"==this.b.size?this.size.v:"large"==this.b.size?this.size.t:
this.size.u},Ta:function(){if(!this.b.boardOnly){var a=this.i.width(),b=8*this.q();l(".moves",this.c).width(a-b-10);l(".moves",this.c).height(b);a={p:[]};this.o(0,a,0,h,h);this.l().html(a.p.join(" "))}},o:function(a,b,c,d,e){a=this.a.f[a];d||b.p.push(a.X(this.c.id,c,e));d=a.children.length;if(1==d)this.o(a.children[0],b,c,j,j);else if(0==d)0<c?(b.p.push(")"),1==c&&b.p.push("<br />")):b.p.push("<span id='"+this.c.id+"move-end' class='move move0'>"+this.a.result+"</span>");else{d=a.children[a.children.length-
1];b.p.push(this.a.f[d].X(this.c.id,c,j));0==c&&b.p.push("<br />");for(e=0;e<a.children.length-1;e++)b.p.push("("),this.o(a.children[e],b,c+1,j,h);this.o(d,b,c,h,j)}},getHeader:function(a){if(this.b.headers==i)return i;a=a.toLowerCase();return this.b.headers.hasOwnProperty(a)?this.b.headers[a]:i},Na:function(){var a=l.trim(this.i.html());this.b.pgn=a;this.b.pgn&&this.Oa();this.Ma()},na:function(a){return/\s*([rnbqkpRNBQKP1-8]+\/){7}([rnbqkpRNBQKP1-8]+)\s[bw-]\s(([a-hkqA-HKQ]{1,4})|(-))\s(([a-h][36])|(-))\s\d+\s\d+\s*/.test(a)},
Oa:function(){var a=this.b.pgn;if("["==a.charAt(0)){var b=a.split("\n\n");if(2==b.length){for(var a=/\[([\w\d]+)\s+"(.*?)"/g,c,d={};c=a.exec(b[0]);)d[c[1].toLowerCase()]=c[2];this.b.headers=d;a=b[1];b=this.getHeader("fen");b!=i&&this.na(b)&&(this.b.fen=b)}}b=a;a=this.Ra();b=b.replace(/(\r\n|\n|\r)/gm," ");b=b.replace(this.h.va,"{$1&lpar;$3}");b=b.replace(this.h.wa,"{$1&rpar;$3}");b=this.Ha(b);b=b.replace("&lpar;","(");b=b.replace("&rpar;",")");c=this.h.za.exec(b);c!=i&&2<=c.length&&(this.a.result=
c[1]);d=-1;c=/(\d+)(\.+)/.exec(b);c!=i&&(d=2*c[1],"."==c[2]&&(d-=1));0<d&&this.M(a,0,d,b);this.a.f=a.r},Ra:function(){var a={r:[],e:0};a.r[0]=new p(0,i,i,-1,"",i,i);return a},Ha:function(a){for(var b=0,c=h,d=/\(([^(]*?)\)/g;c;)a.match(d)&&(a=a.replace(d,"%%"+b+"% $1 %"+b+"%%")),c=j,a.match(d)&&(c=h,b+=1);return a},M:function(a,b,c,d){for(var e=this.R(c),f=RegExp("%%(\\d+)%\\s*"+e+"\\s*(\\w\\S+)"+this.h.ma+"(?:\\s+(.*?))?%\\1%%","g"),g,m;(g=f.exec(d))!==i;){m=l.trim(g[2]);var k="",n="";g[3]&&(n=l.trim(g[3]));
if(g[4]){for(k=l.trim(g[4]);"{"===k.charAt(0);)k=k.substr(1);for(;"}"===k.charAt(k.length-1);)k=k.slice(0,-1);0<k.length&&(this.a.Q=h)}a.e++;a.r[a.e]=new p(a.e,e.replace(/\\/g,""),m,b,k,n,c);a.r[b].children.push(a.e);g=g[5];g!=i&&(g=l.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.R(c+1).replace(/\\/g,"")+" "+g),this.M(a,a.e,c+1,g))}d=d.replace(f,"");g=RegExp("(?:^|\\s+)"+e+"\\s*(\\w\\S+)"+this.h.ma+"(?:\\s+(.*)|($))","m").exec(d);if(g!=i){m=l.trim(g[1]);n=k="";g[2]&&(n=l.trim(g[2]));if(g[3]){for(k=
l.trim(g[3]);"{"===k.charAt(0);)k=k.substr(1);for(;"}"===k.charAt(k.length-1);)k=k.slice(0,-1);0<k.length&&(this.a.Q=h)}a.e++;a.r[a.e]=new p(a.e,e.replace(/\\/g,""),m,b,k,n,c);a.r[b].children.push(a.e);g=g[4];g!=i&&(g=l.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.R(c+1).replace(/\\/g,"")+" "+g),this.M(a,a.e,c+1,g))}},R:function(a){var b=Math.ceil(a/2).toString(),c="\\.";0==a%2&&(c="\\.\\.\\.");return b+c},Ma:function(){if(this.na(this.b.fen)){for(var a=this.b.fen.split(" "),b=a[0].split("/"),
c=112,d=0,e=0;8>e;e++){for(var f=d=0;8>f;f++){var g=b[e].charAt(d);if(g!=i&&isNaN(g)){var m=g.toLowerCase()==g?"b":"w";this.a.position[c+f]=m+g.toLowerCase();"k"==g.toLowerCase()&&("w"==m?this.a.U=c+f:this.a.K=c+f)}else f+=+g-1;d++}c-=16}"b"==a[1]&&(this.a.g=-1)}},Sa:function(){this.i.empty();this.i.attr("tabindex",-1);0==this.s().size()&&this.i.append('<div class="board"></div>').css({position:"relative"});this.b.boardOnly||0==this.l().size()&&this.i.append('<div class="moves"></div>');this.b.hideControls||
0==this.V().size()&&this.i.append('<div class="controls"></div>');!this.b.boardOnly&&!this.b.hideAnnotations&&0==this.fa().size()&&(this.a.Q||this.b.showAnnotations)&&this.i.append('<div class="notes"></div>');var a=this.s(),b=this.q(),c=this.b.lightColor,d=this.b.darkColor,e,f;f="<table class='chess-replayer-board'>";for(var g=7;0<=g;g--){f+="<tr>";for(var m=0;7>=m;m++)e=0==(m+g)%2?d:c,f+="<td style='min-width: "+b+"px; width: "+b+"px; min-height: "+b+"px; height: "+b+"px; background-color: "+e+
";'></td>";f+="</tr>"}f+="</table>";this.i.addClass("chess-replayer");a.html(f);this.V().html('<a class="start button" href="#">|< Start</a><a class="back button" href="#"><< Back</a><a class="flip button" href="#">Flip</a><a class="next button" href="#">Next >></a><a class="end button" href="#">End >|</a>')},pa:function(){for(var a=this.q(),b=this.s(),c=this.O(),d=this.P(),e=7;0<=e;e--)for(var f=0;7>=f;f++){var g=16*e+f,m=this.a.position[g];if(m!=i){g=this.c.id+g;b.append("<div id='"+g+"' class='"+
m+"-"+this.b.size+" chess-piece'></div>");var m=a*(7-e)+d,k=a*f+c;l("#"+g).css({position:"absolute",top:m,left:k,height:a+"px",width:a+"px"})}}},N:function(){var a=this.q(),b=this.s(),c=7*a,d=this.O(),e=this.P(),f,g,m,k,n=this,r=setInterval(function(){l(".chess-piece",b).is(":animated")||(clearInterval(r),b.children(".chess-piece").each(function(){f=parseInt(l(this).css("top"),10)-e;g=parseInt(l(this).css("left"),10)-d;k=c-g+d;m=c-f+e;l(this).css({position:"absolute",top:m,left:k})}),n.d.direction*=
-1)},100)},Ka:function(){var a=j;this.b.startFlipped&&(a=h);if(!("startFlipped"in this.T)){-1==this.a.g&&(a=h);var b=this.getHeader("StartFlipped");b!=i&&(a="true"==b.toLowerCase()||"1"==b?h:j)}var b=0,c="startPly"in this.T?parseInt(this.T.startPly,10):parseInt(this.getHeader("StartPly"),10);c!=i&&0<c&&(b=c);a&&this.N();if(0<b&&(c=this.a.f[0],this.a.f[c.children[c.children.length-1]].S<b))for(a=0;c!=i&&0<c.children.length&&a<b;)a=c.children[c.children.length-1],this.F(a,h),c=this.a.f[a],a=c.S},ba:function(){for(;0<
this.a.C;)this.A(h)},ca:function(a){a=parseInt(a,10);if(a!=i&&a!=this.a.e){for(var b=[this.a.e],c=this.a.f[this.a.e];0<=c.m;)b.unshift(c.m),c=this.a.f[c.m];for(var d=[a],c=this.a.f[a];0<=c.m;)d.unshift(c.m),c=this.a.f[c.m];for(var c=0,e=Math.min(b.length,d.length),f=0;f<e&&b[f]==d[f];f++)c=b[f];for(;this.a.e>c;)this.A(h);if(this.a.e!=a)for(;this.a.e<a;)this.F(d[f],h),f++}},G:function(){this.ca(this.a.f.length-1)},$:function(){for(var a=this.a.f[this.a.e];a!=i&&0<a.children.length;)a=a.children[a.children.length-
1],this.F(a,h),a=this.a.f[a]},H:function(a){var b=this.a.f[this.a.e];if(0==b.children.length)return j;if(1==b.children.length||this.d.n){var c=b.children[b.children.length-1];this.d.n&&(c=b.children[this.d.k],this.L());this.F(c,a)}else this.xa(b);return h},L:function(){this.d.n&&(this.d.n=j,l(".modal li",this.c).unbind("click"),l(".modal",this.c).remove(),this.i.focus())},xa:function(a){for(var b=a.children.length,c="",c='<div class="modal"><ul>',d=b-1;0<=d;d--)c+='<li class="'+d+'">'+this.a.f[a.children[d]].o(h)+
"</li>";this.s().append(c+"</ul></div>");a=8*this.q();l(".modal",this.c).css({top:10,left:a+20});var e=this;l(".modal li",this.c).click(function(a){a=parseInt(l(a.target).attr("class"),10);e.d.k=a;e.H(j)});this.d.n=h;this.d.k=b-1;this.d.Z=b;l(".modal ."+this.d.k,this.c).toggleClass("selected")},Ja:function(){this.d.k+1>=this.d.Z||(this.d.k++,l(".modal .selected",this.c).toggleClass("selected"),l("."+this.d.k,".modal").toggleClass("selected"))},Ia:function(){0>=this.d.k||(this.d.k--,l(".modal .selected",
this.c).toggleClass("selected"),l("."+this.d.k,".modal").toggleClass("selected"))},F:function(a,b){if(a!=i){var c=this.a.f[a];this.la(c);this.W(c,1,b);this.a.C++;this.a.e=a;this.a.g*=-1}},A:function(a){if(this.d.n)return this.L(),h;if(0<this.a.C){var b=this.a.f[this.a.e],c=b.m;this.la(this.a.f[c]);this.W(b,-1,a);this.a.C--;this.a.e=c;this.a.g*=-1;return h}return j},la:function(a){this.Wa(a.ua);l(".active",this.c).toggleClass("active");var b=l("#"+this.c.id+"move"+a.I.toString());b.toggleClass("active");
if(0<a.I&&!this.b.boardOnly){a=b.position().top;b=b.height();if(a<b){var c=b-a,d=this.l().scrollTop();d>c?this.l().scrollTop(d-c):0<d&&this.l().scrollTop(0)}a+b>this.l().height()&&(a=a+b-this.l().height(),this.l().scrollTop(this.l().scrollTop()+a))}},Ea:function(a){return"Q"==a||"R"==a||"B"==a},Ba:function(a){switch(a){case "Q":return this.w.Ua;case "R":return this.w.Va;case "B":return this.w.qa;case "N":return this.w.Ga;case "K":return this.w.Fa}},ya:function(a,b){for(var c=this.Ea(a),d=this.Ba(a),
e=(1==this.a.g?"w":"b")+a.toLowerCase(),f=[],g,m,k=0;k<d.length;k++){m=d[k];for(g=b+m;!(g&136);){if(this.a.position[g]!=i){this.a.position[g]==e&&f.push(g);break}g+=m;if(!c)break}}return f},Aa:function(a){if(this.h.sa.test(a.move)){var a=1==this.a.g?0:7,b=16*a+4,a=16*a;return["m:"+b.toString()+":"+(b-2).toString(),"m:"+a.toString()+":"+(a+3).toString()]}if(this.h.ra.test(a.move))return a=1==this.a.g?0:7,b=16*a+4,a=16*a+7,["m:"+b.toString()+":"+(b+2).toString(),"m:"+a.toString()+":"+(a-2).toString()];
if(this.h.ja.test(a.move)){var b=this.h.ja.exec(a.move)[0],c=this.h.Pa.exec(a.move),d=c[3]-1,c=c[2].toLowerCase().charCodeAt(0)-97,d=16*d+c,c=this.ya(b,d),b=[];if(1==c.length)b=["m:"+c[0]+":"+d];else{var e=this.h.Qa.exec(a.move);if(e[1]!=i&&""!=e[1]){for(var f=[],g=e[1].toLowerCase().charCodeAt(0)-97,a=0;a<c.length;a++)c[a]%16==g&&f.push(c[a]);c=f}if(e[2]!=i&&""!=e[2]){f=[];e=e[2]-1;for(a=0;a<c.length;a++)Math.floor(c[a]/16)==e&&f.push(c[a]);c=f}if(1==c.length)b=["m:"+c[0]+":"+d];else{e=[];f=1==this.a.g?
this.a.U:this.a.K;for(a=0;a<c.length;a++)this.Da(c[a],f)||e.push(c[a]);1==e.length&&(b=["m:"+e[0]+":"+d])}}this.a.position[d]!=i&&b.splice(0,0,"r:"+d+":"+this.a.position[d].toString())}else{e=c=d=i;b=[];f=1==this.a.g?"w":"b";if(this.h.ha.test(a.move))if(b=this.h.ha.exec(a.move),c=b[1].toLowerCase().charCodeAt(0)-97,d=b[2]-1,b=d-1*this.a.g,b=16*b+c,this.a.position[b]==f+"p")e=b,b=["m:"+b+":"+(16*d+c).toString()];else{if(1==this.a.g){if(3==d&&"wp"==this.a.position[16+c]&&this.a.position[32+c]==i)return b=
["m:"+(16+c).toString()+":"+(48+c).toString(),"e:"+c.toString()]}else if(4==d&&"bp"==this.a.position[96+c]&&this.a.position[80+c]==i)return b=["m:"+(96+c).toString()+":"+(64+c).toString(),"e:"+c.toString()];return[]}else if(this.h.ga.test(a.move)){b=this.h.ga.exec(a.move);c=b[2].toLowerCase().charCodeAt(0)-97;d=b[3]-1;f=b[1].toLowerCase().charCodeAt(0)-97;b=d-1*this.a.g;if(this.a.z==c&&(e=i,1==this.a.g&&5==d&&(e=64+c),-1==this.a.g&&2==d&&(e=48+c),e!=i))return["r:"+e.toString()+":"+this.a.position[e],
"m:"+(16*b+f).toString()+":"+(16*d+c).toString()];e=16*b+f;b=["r:"+(16*d+c).toString()+":"+this.a.position[16*d+c],"m:"+(16*b+f).toString()+":"+(16*d+c).toString()]}if(this.h.ia.test(a.move)){f=this.h.ia.exec(a.move)[1];g=1==this.a.g?"w":"b";d=(16*d+c).toString();c=[];for(a=0;a<b.length;a++)"m"!=b[a].split(":")[0]&&c.push(b[a]);c.push("p:"+d+":"+e.toString()+":"+g+":"+f.toLowerCase());b=c}}return b},Da:function(a,b){var c=a-b,d=Math.abs(c),e=i;0<d&&7>d?e=1:0==d%15?e=15:0==d%16?e=16:0==d%17&&(e=17);
if(e!==i){d=e;0>c&&(e*=-1);for(var c=b+e,f=j;!(c&136);){if(this.a.position[c]!=i)if(c==a)f=h;else{if(f){e=this.a.position[c];c=e.charAt(1);if(e.charAt(0)!=(1==this.a.g?"b":"w"))break;return 15==d||17==d?"q"==c||"b"==c:"r"==c||"q"==c}break}c+=e}}return j},W:function(a,b,c){"undefined"===typeof c&&(c=j);if(0<b){if(a.j==i||0==a.j.length)b=this.Aa(a),this.a.f[a.I].j=b,a.j=b;this.a.z="";for(b=0;b<a.j.length;b++){var d=a.j[b],d=d.split(":");switch(d[0]){case "m":this.aa(d[1],d[2],c);break;case "a":this.B(d[1],
d[2]);break;case "r":this.J(d[1]);break;case "e":this.a.z=d[1];break;case "p":this.J(d[2]),this.B(d[1],d[3]+d[4])}}}else if(0>b){if(a.j==i)return j;d=this.a.f[a.m];if(d!=i&&d.j!=i){for(var e=j,b=0;b<d.j.length;b++)"e"==d.j[b].charAt(0)&&(e=h,this.a.z=parseInt(d.j[b].charAt(2),8));e||(this.a.z="")}for(b=a.j.length-1;0<=b;b--)switch(d=a.j[b],d=d.split(":"),d[0]){case "m":this.aa(d[2],d[1],c);break;case "a":this.J(d[1]);break;case "r":this.B(d[1],d[2]);break;case "p":this.J(d[1]),this.B(d[2],d[3]+"p")}}},
B:function(a,b){var c=this.c.id+a;this.s().append("<div id='"+c+"' class='"+b+"-"+this.b.size+" chess-piece'></div>");var d=this.q(),e=Math.floor(a/16),f=a%16;-1==this.d.direction?e=7-e:f=7-f;e=d*e+this.P();f=d*f+this.O();l("#"+c).css({position:"absolute",top:e,left:f,height:d+"px",width:d+"px"});this.a.position[a]=b},J:function(a){l("#"+(this.c.id+a)).remove();this.a.position[a]=i},aa:function(a,b,c){var d=this.c.id+a,e=this.c.id+b,f=this.q(),g=(Math.floor(b/16)-Math.floor(a/16))*f*this.d.direction,
f=(a%16-b%16)*f*this.d.direction;c?l("#"+d).css({top:"+="+g+"px",left:"+="+f+"px"}):l("#"+d).animate({top:"+="+g+"px",left:"+="+f+"px"},"fast");l("#"+d).attr("id",e);c=this.a.position[a];this.a.position[b]=c;this.a.position[a]=i;"wk"===c&&(this.a.U=b);"bk"===c&&(this.a.K=b)}};q.D=q.prototype.D;l.fn.ka=function(a){return this.each(function(){(new q(this,a)).Ca()})};jQuery.prototype.replayer=l.fn.ka;l.fn.ka.defaults=q.D;})()