/*
 Chess Replayer 1.1.1

 Copyright (c) 2012 Andrew Hoy.  All rights reserved.

 This library has not been released to the public.  If you are interested
 in using jquery.chess-replayer, please contact Andrew Hoy at
 andrewphoy@gmail.com for more information.
*/
(function(){var h=!0,i=null,j=!1,m=jQuery;
function o(a,b,c,d,e,f,g){this.M=a;this.Ha=b;this.move=c;this.l=d;this.qa=e;this.$=f;this.Oa=g;this.j=[];this.children=[];this.aa=function(a){"$"==a.charAt(0)&&(a=a.substring(1));switch(parseInt(a,10)){case 1:return"!";case 2:return"?";case 3:return"!!";case 4:return"??";case 5:return"!?";case 6:return"?!";case 7:case 8:return"&#x25a1;";case 10:return"=";case 13:return"&infin;";case 14:return"&#x2a72;";case 15:return"&#x2a71;";case 16:return"&plusmn;";case 17:return"&#8723;";case 18:return"&#43;&minus;";
case 19:return"&minus;&#43;";case 22:case 23:return"&#x2a00;";case 32:case 33:return"&#x27F3;";case 36:case 37:return"&#x2192;";case 40:case 41:return"&#x2191;";case 132:case 133:return"&#x21c6;";case 140:return"&#x2206;";case 142:return"&#x2313;";case 145:return"RR";case 146:return"N";case 239:return"&#x21d4;";case 240:return"&#x21d7;";case 242:return"&#x27eb;";case 243:return"&#x27ea;";case 244:return"&#x2715;";case 245:return"&#x22a5;";default:return""}};this.n=function(a){var b="";a&&(b+=this.Ha+
" ");b+=this.move;if(this.$)for(var a=this.$.split(" "),b=b+this.aa(a[0]),c=1;c<a.length;c++)b+=" "+this.aa(a[c]);return b};this.toString=function(){return this.n(j)};this.S=function(a,b,c){c=c||1==this.Oa%2||0==this.l;a=a="<span id='"+a+"move"+this.M+"' class='move move"+b+"'>";return a+=this.n(c)+"</span>"}}
function p(a,b){this.c=a;this.c.id||(this.c.id="cr"+Math.random().toString(36).substring(5));this.h=m(a);this.options=b;this.T=this.h.data("replayer-options");this.a={headers:[],result:"",e:0,f:1,w:"",A:0,position:[],Wa:0,O:-1,F:-1,g:[]};this.d={m:j,U:0,k:0,direction:-1}}
p.prototype={B:{fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",size:"small",lightColor:"#CCCCCC",darkColor:"#999999",boardOnly:j,scrollOnEnd:j,startFlipped:j},size:{u:45,t:60,s:80},shift:{left:{u:13,t:21,s:31},top:{u:12,t:20,s:28}},i:{ia:"((?:\\s*\\$\\d+)*)(\\s*\\{[^\\}]*\\})*",va:/(1-0|0-1|1\/2-1\/2|\*)$/g,ra:/\{([^}]*?)(\()(.*?)\}/g,sa:/\{([^}]*?)(\))(.*?)\}/g,na:/^O-O/,oa:/^O-O-O/,ea:/^([KQBNR])/,Ma:/(.*)([a-h])([1-8])/,Na:/^[KQBNR]([a-h])?([1-8])?x?[a-h][1-8]/,da:/^([a-h])([1-8])/,
ca:/^([a-h])x([a-h])([1-8])/,La:/=([QBNR])/},v:{Ta:[-16,-1,1,16],Ca:[-33,-31,-18,-14,14,18,31,33],ma:[-17,-15,15,17],Sa:[-17,-15,15,17,-16,-1,1,16],Ba:[-17,-16,-15,-1,1,15,16,17]},ya:function(){this.Va=m.extend({},this.options,this.T);this.b=m.extend({},this.B,this.options,this.T);this.pa();this.Ja();this.Qa();this.Ra();this.la();this.Ga();this.ka()},ka:function(){var a=this;this.h.keydown(function(b){return 39==b.which?(a.D(),j):37==b.which?(a.z(),j):40==b.which&&a.d.m?(b.preventDefault(),a.Ea(),
j):38==b.which&&a.d.m?(b.preventDefault(),a.Fa(),j):70==b.which?(a.J(),j):83==b.which||36==b.which||72==b.which?(a.X(),j):69==b.which||35==b.which?(b.ctrlKey?a.C():a.V(),j):27==b.which?(a.G(),j):h});m(".board,.moves",this.c).bind("mousewheel DOMMouseScroll",function(b){var c=j;(c=0<(-b.originalEvent.detail||b.wheelDelta||b.originalEvent.wheelDelta)?a.z():a.D())&&b.preventDefault();return!c&&a.b.scrollOnEnd});m(".next",this.c).click(function(){a.D();return j});m(".back",this.c).click(function(){a.z();
return j});m(".start",this.c).click(function(){a.X();return j});m(".flip",this.c).click(function(){a.J();return j});m(".end",this.c).click(function(){a.C();return j});m(".move",this.c).click(function(){var b=this.id.substring(a.c.id.length+4);"-end"==b?a.C():a.Y(b);return j})},pa:function(){this.b.size=this.b.size.toLowerCase();"small"!=this.b.size&&"large"!=this.b.size&&(this.b.size="medium")},K:function(){return"small"==this.b.size?this.shift.left.u:"large"==this.b.size?this.shift.left.s:this.shift.left.t},
L:function(){return"small"==this.b.size?this.shift.top.u:"large"==this.b.size?this.shift.top.s:this.shift.top.t},r:function(){return this.h.find(".board")},Q:function(){return this.h.find(".controls")},Z:function(){return this.h.find(".moves")},ba:function(){return this.h.find(".notes")},Ua:function(a){this.b.boardOnly||this.ba().html(a)},p:function(){return"small"==this.b.size?this.size.u:"large"==this.b.size?this.size.s:this.size.t},Ra:function(){if(!this.b.boardOnly){var a=this.h.width(),b=8*this.p();
m(".moves",this.c).width(a-b-10);m(".moves",this.c).height(b);a={o:[]};this.n(0,a,0,h,h);this.Z().html(a.o.join(" "))}},n:function(a,b,c,d,e){a=this.a.g[a];d||b.o.push(a.S(this.c.id,c,e));d=a.children.length;if(1==d)this.n(a.children[0],b,c,j,j);else if(0==d)0<c?(b.o.push(")"),1==c&&b.o.push("<br />")):b.o.push("<span id='"+this.c.id+"move-end' class='move move0'>"+this.a.result+"</span>");else{d=a.children[a.children.length-1];b.o.push(this.a.g[d].S(this.c.id,c,j));0==c&&b.o.push("<br />");for(e=
0;e<a.children.length-1;e++)b.o.push("("),this.n(a.children[e],b,c+1,j,h);this.n(d,b,c,h,j)}},getHeader:function(a){a=a.toLowerCase();return this.b.headers.hasOwnProperty(a)?this.b.headers[a]:i},Ja:function(){var a=m.trim(this.h.html());this.b.pgn=a;this.b.pgn&&this.Ka();this.Ia()},ja:function(a){return/\s*([rnbqkpRNBQKP1-8]+\/){7}([rnbqkpRNBQKP1-8]+)\s[bw-]\s(([a-hkqA-HKQ]{1,4})|(-))\s(([a-h][36])|(-))\s\d+\s\d+\s*/.test(a)},Ka:function(){var a=this.b.pgn;if("["==a.charAt(0)){var b=a.split("\n\n");
if(2==b.length){for(var a=/\[([\w\d]+)\s+"(.*?)"/g,c,d={};c=a.exec(b[0]);)d[c[1].toLowerCase()]=c[2];this.b.headers=d;a=b[1];b=this.getHeader("fen");b!=i&&this.ja(b)&&(this.b.fen=b)}}b=a;a=this.Pa();b=b.replace(/(\r\n|\n|\r)/gm," ");b=b.replace(this.i.ra,"{$1&lpar;$3}");b=b.replace(this.i.sa,"{$1&rpar;$3}");b=this.Da(b);b=b.replace("&lpar;","(");b=b.replace("&rpar;",")");c=this.i.va.exec(b);c!=i&&2<=c.length&&(this.a.result=c[1]);d=-1;c=/(\d+)(\.+)/.exec(b);c!=i&&(d=2*c[1],"."==c[2]&&(d-=1));0<d&&
this.I(a,0,d,b);this.a.g=a.q},Pa:function(){var a={q:[],e:0};a.q[0]=new o(0,i,i,-1,"",i,i);return a},Da:function(a){for(var b=0,c=h,d=/\(/,e=/\(([^(]*?)\)/g;c;)a.match(e)&&(a=a.replace(e,"%%"+b+"% $1 %"+b+"%%")),c=j,a.match(d)&&(c=h,b+=1);return a},I:function(a,b,c,d){for(var e=this.N(c),f=RegExp("%%(\\d+)%\\s*"+e+"\\s*(\\w\\S+)"+this.i.ia+"(?:\\s+(.*?))?%\\1%%","g"),g,l;(g=f.exec(d))!==i;){l=m.trim(g[2]);var k="",n="";g[3]&&(n=m.trim(g[3]));if(g[4]){for(k=m.trim(g[4]);"{"===k.charAt(0);)k=k.substr(1);
for(;"}"===k.charAt(k.length-1);)k=k.slice(0,-1)}a.e++;a.q[a.e]=new o(a.e,e.replace(/\\/g,""),l,b,k,n,c);a.q[b].children.push(a.e);g=g[5];g!=i&&(g=m.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.N(c+1).replace(/\\/g,"")+" "+g),this.I(a,a.e,c+1,g))}d=d.replace(f,"");g=RegExp("(?:^|\\s+)"+e+"\\s*(\\w\\S+)"+this.i.ia+"(?:\\s+(.*)|($))","m").exec(d);if(g!=i){l=m.trim(g[1]);n=k="";g[2]&&(n=m.trim(g[2]));if(g[3]){for(k=m.trim(g[3]);"{"===k.charAt(0);)k=k.substr(1);for(;"}"===k.charAt(k.length-1);)k=k.slice(0,
-1)}a.e++;a.q[a.e]=new o(a.e,e.replace(/\\/g,""),l,b,k,n,c);a.q[b].children.push(a.e);g=g[4];g!=i&&(g=m.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.N(c+1).replace(/\\/g,"")+" "+g),this.I(a,a.e,c+1,g))}},N:function(a){var b=Math.ceil(a/2).toString(),c="\\.";0==a%2&&(c="\\.\\.\\.");return b+c},Ia:function(){if(this.ja(this.b.fen)){for(var a=this.b.fen.split(" "),b=a[0].split("/"),c=112,d=0,e=0;8>e;e++){for(var f=d=0;8>f;f++){var g=b[e].charAt(d);if(g!=i&&isNaN(g)){var l=g.toLowerCase()==g?"b":"w";
this.a.position[c+f]=l+g.toLowerCase();"k"==g.toLowerCase()&&("w"==l?this.a.O=c+f:this.a.F=c+f)}else f+=+g-1;d++}c-=16}"b"==a[1]&&(this.a.f=-1)}},Qa:function(){this.h.empty();this.h.attr("tabindex",-1);0==this.r().size()&&this.h.append('<div class="board"></div>').css({position:"relative"});this.b.boardOnly||0==this.Z().size()&&this.h.append('<div class="moves"></div>');0==this.Q().size()&&this.h.append('<div class="controls"></div>');this.b.boardOnly||0==this.ba().size()&&this.h.append('<div class="notes"></div>');
var a=this.r(),b=this.p(),c=this.b.lightColor,d=this.b.darkColor,e,f;f="<table class='chess-replayer-board'>";for(var g=7;0<=g;g--){f+="<tr>";for(var l=0;7>=l;l++)e=0==(l+g)%2?d:c,f+="<td style='min-width: "+b+"px; width: "+b+"px; min-height: "+b+"px; height: "+b+"px; background-color: "+e+";'></td>";f+="</tr>"}f+="</table>";this.h.addClass("chess-replayer");a.html(f);this.Q().html('<a class="start button" href="#">|< Start</a><a class="back button" href="#"><< Back</a><a class="flip button" href="#">Flip</a><a class="next button" href="#">Next >></a><a class="end button" href="#">End >|</a>')},
la:function(){for(var a=this.p(),b=this.r(),c=this.K(),d=this.L(),e=7;0<=e;e--)for(var f=0;7>=f;f++){var g=16*e+f,l=this.a.position[g];if(l!=i){g=this.c.id+g;b.append("<div id='"+g+"' class='"+l+"-"+this.b.size+" chess-piece'></div>");var l=a*(7-e)+d,k=a*f+c;m("#"+g).css({position:"absolute",top:l,left:k,height:a+"px",width:a+"px"})}}},J:function(){var a=this.p(),b=this.r(),c=7*a,d=this.K(),e=this.L(),f,g,l,k;b.children(".chess-piece").each(function(){f=parseInt(m(this).css("top"),10)-e;g=parseInt(m(this).css("left"),
10)-d;k=c-g+d;l=c-f+e;m(this).css({position:"absolute",top:l,left:k})});this.d.direction*=-1},Ga:function(){var a=j;this.b.startFlipped&&(a=h);!("startFlipped"in this.Va)&&-1==this.a.f&&(a=h);a&&this.J()},X:function(){for(;0<this.a.A;)this.z()},Y:function(a){a=parseInt(a,10);if(a!=i&&a!=this.a.e){for(var b=[this.a.e],c=this.a.g[this.a.e];0<=c.l;)b.unshift(c.l),c=this.a.g[c.l];for(var d=[a],c=this.a.g[a];0<=c.l;)d.unshift(c.l),c=this.a.g[c.l];for(var c=0,e=Math.min(b.length,d.length),f=0;f<e&&b[f]==
d[f];f++)c=b[f];for(;this.a.e>c;)this.z();if(this.a.e!=a)for(;this.a.e<a;)this.H(d[f]),f++}},C:function(){this.Y(this.a.g.length-1)},V:function(){for(var a=this.a.g[this.a.e];a!=i&&0<a.children.length;)a=a.children[a.children.length-1],this.H(a),a=this.a.g[a]},D:function(){var a=this.a.g[this.a.e];if(0==a.children.length)return j;if(1==a.children.length||this.d.m){var b=a.children[a.children.length-1];this.d.m&&(b=a.children[this.d.k],this.G());this.H(b)}else this.ta(a);return h},G:function(){this.d.m&&
(this.d.m=j,m(".modal li",this.c).unbind("click"),m(".modal",this.c).remove(),this.h.focus())},ta:function(a){for(var b=a.children.length,c="",c='<div class="modal"><ul>',d=b-1;0<=d;d--)c+='<li class="'+d+'">'+this.a.g[a.children[d]].n(h)+"</li>";this.r().append(c+"</ul></div>");a=8*this.p();m(".modal",this.c).css({top:10,left:a+20});var e=this;m(".modal li",this.c).click(function(a){a=parseInt(m(a.target).attr("class"),10);e.d.k=a;e.D()});this.d.m=h;this.d.k=b-1;this.d.U=b;m(".modal ."+this.d.k,
this.c).toggleClass("selected")},Fa:function(){this.d.k+1>=this.d.U||(this.d.k++,m(".modal .selected",this.c).toggleClass("selected"),m("."+this.d.k,".modal").toggleClass("selected"))},Ea:function(){0>=this.d.k||(this.d.k--,m(".modal .selected",this.c).toggleClass("selected"),m("."+this.d.k,".modal").toggleClass("selected"))},H:function(a){if(a!=i){var b=this.a.g[a];this.ha(b);this.R(b,1);this.a.A++;this.a.e=a;this.a.f*=-1}},z:function(){if(this.d.m)return this.G(),h;if(0<this.a.A){var a=this.a.g[this.a.e],
b=a.l;this.ha(this.a.g[b]);this.R(a,-1);this.a.A--;this.a.e=b;this.a.f*=-1;return h}return j},ha:function(a){this.Ua(a.qa);m(".active",this.c).toggleClass("active");m("#"+this.c.id+"move"+a.M.toString()).toggleClass("active")},Aa:function(a){return"Q"==a||"R"==a||"B"==a},xa:function(a){switch(a){case "Q":return this.v.Sa;case "R":return this.v.Ta;case "B":return this.v.ma;case "N":return this.v.Ca;case "K":return this.v.Ba}},ua:function(a,b){for(var c=this.Aa(a),d=this.xa(a),e=(1==this.a.f?"w":"b")+
a.toLowerCase(),f=[],g,l,k=0;k<d.length;k++){l=d[k];for(g=b+l;!(g&136);){if(this.a.position[g]!=i){this.a.position[g]==e&&f.push(g);break}g+=l;if(!c)break}}return f},wa:function(a){if(this.i.oa.test(a.move)){var b=1==this.a.f?0:7,a=16*b+4,b=16*b;return["m:"+a.toString()+":"+(a-2).toString(),"m:"+b.toString()+":"+(b+3).toString()]}if(this.i.na.test(a.move))return b=1==this.a.f?0:7,a=16*b+4,b=16*b+7,["m:"+a.toString()+":"+(a+2).toString(),"m:"+b.toString()+":"+(b-2).toString()];if(this.i.ea.test(a.move)){var c=
this.i.ea.exec(a.move)[0],d=this.i.Ma.exec(a.move),b=d[3]-1,d=d[2].toLowerCase().charCodeAt(0)-97,b=16*b+d,c=this.ua(c,b),d=[];if(1==c.length)d=["m:"+c[0]+":"+b];else{var e=this.i.Na.exec(a.move);if(e[1]!=i&&""!=e[1]){for(var f=[],g=e[1].toLowerCase().charCodeAt(0)-97,a=0;a<c.length;a++)c[a]%16==g&&f.push(c[a]);c=f}if(e[2]!=i&&""!=e[2]){f=[];e=e[2]-1;for(a=0;a<c.length;a++)Math.floor(c[a]/16)==e&&f.push(c[a]);c=f}if(1==c.length)d=["m:"+c[0]+":"+b];else{e=[];f=1==this.a.f?this.a.O:this.a.F;for(a=0;a<
c.length;a++)this.za(c[a],f)||e.push(c[a]);1==e.length&&(d=["m:"+e[0]+":"+b])}}this.a.position[b]!=i&&d.splice(0,0,"r:"+b+":"+this.a.position[b].toString())}else{d=[];c=1==this.a.f?"w":"b";if(this.i.da.test(a.move))if(e=this.i.da.exec(a.move),d=e[1].toLowerCase().charCodeAt(0)-97,b=e[2]-1,e=b-1*this.a.f,e=16*e+d,this.a.position[e]==c+"p")d=["m:"+e+":"+(16*b+d).toString()];else{if(1==this.a.f){if(3==b&&"wp"==this.a.position[16+d]&&this.a.position[32+d]==i)return d=["m:"+(16+d).toString()+":"+(48+d).toString(),
"e:"+d.toString()]}else if(4==b&&"bp"==this.a.position[96+d]&&this.a.position[80+d]==i)return d=["m:"+(96+d).toString()+":"+(64+d).toString(),"e:"+d.toString()];return[]}else if(this.i.ca.test(a.move)){e=this.i.ca.exec(a.move);d=e[2].toLowerCase().charCodeAt(0)-97;b=e[3]-1;c=e[1].toLowerCase().charCodeAt(0)-97;e=b-1*this.a.f;if(this.a.w==d&&(f=i,1==this.a.f&&5==b&&(f=64+d),-1==this.a.f&&2==b&&(f=48+d),f!=i))return["r:"+f.toString()+":"+this.a.position[f],"m:"+(16*e+c).toString()+":"+(16*b+d).toString()];
d=["r:"+(16*b+d).toString()+":"+this.a.position[16*b+d],"m:"+(16*e+c).toString()+":"+(16*b+d).toString()]}this.i.La.test(a.move)}return d},za:function(a,b){var c=a-b,d=Math.abs(c),e=i;0<d&&7>d?e=1:0==d%15?e=15:0==d%16?e=16:0==d%17&&(e=17);if(e!==i){d=e;0>c&&(e*=-1);for(var c=b+e,f=j;!(c&136);){if(this.a.position[c]!=i)if(c==a)f=h;else{if(f){e=this.a.position[c];c=e.charAt(1);if(e.charAt(0)!=(1==this.a.f?"b":"w"))break;return 15==d||17==d?"q"==c||"b"==c:"r"==c||"q"==c}break}c+=e}}return j},R:function(a,
b){if(0<b){if(a.j==i||0==a.j.length){var c=this.wa(a);this.a.g[a.M].j=c;a.j=c}this.a.w="";for(c=0;c<a.j.length;c++){var d=a.j[c],d=d.split(":");switch(d[0]){case "m":this.W(d[1],d[2]);break;case "a":this.P(d[1],d[2]);break;case "r":this.fa(d[1]);break;case "e":this.a.w=d[1]}}}else if(0>b){if(a.j==i)return j;d=this.a.g[a.l];if(d!=i&&d.j!=i){for(var e=j,c=0;c<d.j.length;c++)"e"==d.j[c].charAt(0)&&(e=h,this.a.w=parseInt(d.j[c].charAt(2),8));e||(this.a.w="")}for(c=a.j.length-1;0<=c;c--)switch(d=a.j[c],
d=d.split(":"),d[0]){case "m":this.W(d[2],d[1]);break;case "a":this.fa(d[1]);break;case "r":this.P(d[1],d[2])}}},P:function(a,b){var c=this.c.id+a;this.r().append("<div id='"+c+"' class='"+b+"-"+this.b.size+" chess-piece'></div>");var d=this.p(),e=Math.floor(a/16),f=a%16;-1==this.d.direction?e=7-e:f=7-f;e=d*e+this.L();f=d*f+this.K();m("#"+c).css({position:"absolute",top:e,left:f,height:d+"px",width:d+"px"});this.a.position[a]=b},fa:function(a){m("#"+(this.c.id+a)).remove();this.a.position[a]=i},W:function(a,
b){var c=this.c.id+a,d=this.c.id+b,e=this.p(),f=(Math.floor(b/16)-Math.floor(a/16))*e*this.d.direction,e=(a%16-b%16)*e*this.d.direction;m("#"+c).animate({top:"+="+f+"px",left:"+="+e+"px"},"fast");m("#"+c).attr("id",d);c=this.a.position[a];this.a.position[b]=c;this.a.position[a]=i;"wk"===c&&(this.a.O=b);"bk"===c&&(this.a.F=b)}};p.B=p.prototype.B;m.fn.ga=function(a){return this.each(function(){(new p(this,a)).ya()})};jQuery.prototype.replayer=m.fn.ga;m.fn.ga.defaults=p.B;})()