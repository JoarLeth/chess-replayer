/*
 Chess Replayer 1.1.3

 Copyright (c) 2012 Andrew Hoy.  All rights reserved.

 This library has not been released to the public.  If you are interested
 in using jquery.chess-replayer, please contact Andrew Hoy at
 andrewphoy@gmail.com for more information.
*/
(function(){var h=!0,i=null,j=!1,m=jQuery;
function o(a,b,c,d,e,f,g){this.H=a;this.Ia=b;this.move=c;this.m=d;this.ra=e;this.aa=f;this.Oa=g;this.j=[];this.children=[];this.ba=function(a){"$"==a.charAt(0)&&(a=a.substring(1));switch(parseInt(a,10)){case 1:return"!";case 2:return"?";case 3:return"!!";case 4:return"??";case 5:return"!?";case 6:return"?!";case 7:case 8:return"&#x25a1;";case 10:return"=";case 13:return"&infin;";case 14:return"&#x2a72;";case 15:return"&#x2a71;";case 16:return"&plusmn;";case 17:return"&#8723;";case 18:return"&#43;&minus;";
case 19:return"&minus;&#43;";case 22:case 23:return"&#x2a00;";case 32:case 33:return"&#x27F3;";case 36:case 37:return"&#x2192;";case 40:case 41:return"&#x2191;";case 132:case 133:return"&#x21c6;";case 140:return"&#x2206;";case 142:return"&#x2313;";case 145:return"RR";case 146:return"N";case 239:return"&#x21d4;";case 240:return"&#x21d7;";case 242:return"&#x27eb;";case 243:return"&#x27ea;";case 244:return"&#x2715;";case 245:return"&#x22a5;";default:return""}};this.o=function(a){var b="";a&&(b+=this.Ia+
" ");b+=this.move;if(this.aa)for(var a=this.aa.split(" "),b=b+this.ba(a[0]),c=1;c<a.length;c++)b+=" "+this.ba(a[c]);return b};this.toString=function(){return this.o(j)};this.U=function(a,b,c){c=c||1==this.Oa%2||0==this.m;a=a="<span id='"+a+"move"+this.H+"' class='move move"+b+"'>";return a+=this.o(c)+"</span>"}}
function p(a,b){this.c=a;this.c.id||(this.c.id="cr"+Math.random().toString(36).substring(5));this.i=m(a);this.options=b;this.V=this.i.data("replayer-options");this.a={headers:[],result:"",e:0,f:1,z:"",C:0,position:[],Wa:0,R:-1,J:-1,g:[]};this.d={n:j,W:0,k:0,direction:-1}}
p.prototype={D:{fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",size:"small",lightColor:"#CCCCCC",darkColor:"#999999",boardOnly:j,scrollOnEnd:j,startFlipped:j},size:{v:45,u:60,t:80},shift:{left:{v:13,u:21,t:31},top:{v:12,u:20,t:28}},h:{ja:"((?:\\s*\\$\\d+)*)(\\s*\\{[^\\}]*\\})*",wa:/(1-0|0-1|1\/2-1\/2|\*)$/g,sa:/\{([^}]*?)(\()(.*?)\}/g,ta:/\{([^}]*?)(\))(.*?)\}/g,oa:/^O-O/,pa:/^O-O-O/,ga:/^([KQBNR])/,Ma:/(.*)([a-h])([1-8])/,Na:/^[KQBNR]([a-h])?([1-8])?x?[a-h][1-8]/,ea:/^([a-h])([1-8])/,
da:/^([a-h])x([a-h])([1-8])/,fa:/=([QBNR])/},w:{Ta:[-16,-1,1,16],Da:[-33,-31,-18,-14,14,18,31,33],na:[-17,-15,15,17],Sa:[-17,-15,15,17,-16,-1,1,16],Ca:[-17,-16,-15,-1,1,15,16,17]},za:function(){this.Va=m.extend({},this.options,this.V);this.b=m.extend({},this.D,this.options,this.V);this.qa();this.Ka();this.Qa();this.Ra();this.ma();this.Ha();this.la()},la:function(){var a=this;this.i.keydown(function(b){return 39==b.which?(a.G(),j):37==b.which?(a.A(),j):40==b.which&&a.d.n?(b.preventDefault(),a.Fa(),
j):38==b.which&&a.d.n?(b.preventDefault(),a.Ga(),j):70==b.which?(a.N(),j):83==b.which||36==b.which||72==b.which?(a.Z(),j):69==b.which||35==b.which?(b.ctrlKey?a.F():a.X(),j):27==b.which?(a.K(),j):h});m(".board,.moves",this.c).bind("mousewheel DOMMouseScroll",function(b){var c=j;(c=0<(-b.originalEvent.detail||b.wheelDelta||b.originalEvent.wheelDelta)?a.A():a.G())&&b.preventDefault();return!c&&a.b.scrollOnEnd});m(".next",this.c).click(function(){a.G();return j});m(".back",this.c).click(function(){a.A();
return j});m(".start",this.c).click(function(){a.Z();return j});m(".flip",this.c).click(function(){a.N();return j});m(".end",this.c).click(function(){a.F();return j});m(".move",this.c).click(function(){var b=this.id.substring(a.c.id.length+4);"-end"==b?a.F():a.$(b);return j})},qa:function(){this.b.size=this.b.size.toLowerCase();"small"!=this.b.size&&"large"!=this.b.size&&(this.b.size="medium")},O:function(){return"small"==this.b.size?this.shift.left.v:"large"==this.b.size?this.shift.left.t:this.shift.left.u},
P:function(){return"small"==this.b.size?this.shift.top.v:"large"==this.b.size?this.shift.top.t:this.shift.top.u},s:function(){return this.i.find(".board")},S:function(){return this.i.find(".controls")},l:function(){return this.i.find(".moves")},ca:function(){return this.i.find(".notes")},Ua:function(a){this.b.boardOnly||this.ca().html(a)},q:function(){return"small"==this.b.size?this.size.v:"large"==this.b.size?this.size.t:this.size.u},Ra:function(){if(!this.b.boardOnly){var a=this.i.width(),b=8*this.q();
m(".moves",this.c).width(a-b-10);m(".moves",this.c).height(b);a={p:[]};this.o(0,a,0,h,h);this.l().html(a.p.join(" "))}},o:function(a,b,c,d,e){a=this.a.g[a];d||b.p.push(a.U(this.c.id,c,e));d=a.children.length;if(1==d)this.o(a.children[0],b,c,j,j);else if(0==d)0<c?(b.p.push(")"),1==c&&b.p.push("<br />")):b.p.push("<span id='"+this.c.id+"move-end' class='move move0'>"+this.a.result+"</span>");else{d=a.children[a.children.length-1];b.p.push(this.a.g[d].U(this.c.id,c,j));0==c&&b.p.push("<br />");for(e=
0;e<a.children.length-1;e++)b.p.push("("),this.o(a.children[e],b,c+1,j,h);this.o(d,b,c,h,j)}},getHeader:function(a){a=a.toLowerCase();return this.b.headers.hasOwnProperty(a)?this.b.headers[a]:i},Ka:function(){var a=m.trim(this.i.html());this.b.pgn=a;this.b.pgn&&this.La();this.Ja()},ka:function(a){return/\s*([rnbqkpRNBQKP1-8]+\/){7}([rnbqkpRNBQKP1-8]+)\s[bw-]\s(([a-hkqA-HKQ]{1,4})|(-))\s(([a-h][36])|(-))\s\d+\s\d+\s*/.test(a)},La:function(){var a=this.b.pgn;if("["==a.charAt(0)){var b=a.split("\n\n");
if(2==b.length){for(var a=/\[([\w\d]+)\s+"(.*?)"/g,c,d={};c=a.exec(b[0]);)d[c[1].toLowerCase()]=c[2];this.b.headers=d;a=b[1];b=this.getHeader("fen");b!=i&&this.ka(b)&&(this.b.fen=b)}}b=a;a=this.Pa();b=b.replace(/(\r\n|\n|\r)/gm," ");b=b.replace(this.h.sa,"{$1&lpar;$3}");b=b.replace(this.h.ta,"{$1&rpar;$3}");b=this.Ea(b);b=b.replace("&lpar;","(");b=b.replace("&rpar;",")");c=this.h.wa.exec(b);c!=i&&2<=c.length&&(this.a.result=c[1]);d=-1;c=/(\d+)(\.+)/.exec(b);c!=i&&(d=2*c[1],"."==c[2]&&(d-=1));0<d&&
this.M(a,0,d,b);this.a.g=a.r},Pa:function(){var a={r:[],e:0};a.r[0]=new o(0,i,i,-1,"",i,i);return a},Ea:function(a){for(var b=0,c=h,d=/\(/,e=/\(([^(]*?)\)/g;c;)a.match(e)&&(a=a.replace(e,"%%"+b+"% $1 %"+b+"%%")),c=j,a.match(d)&&(c=h,b+=1);return a},M:function(a,b,c,d){for(var e=this.Q(c),f=RegExp("%%(\\d+)%\\s*"+e+"\\s*(\\w\\S+)"+this.h.ja+"(?:\\s+(.*?))?%\\1%%","g"),g,l;(g=f.exec(d))!==i;){l=m.trim(g[2]);var k="",n="";g[3]&&(n=m.trim(g[3]));if(g[4]){for(k=m.trim(g[4]);"{"===k.charAt(0);)k=k.substr(1);
for(;"}"===k.charAt(k.length-1);)k=k.slice(0,-1)}a.e++;a.r[a.e]=new o(a.e,e.replace(/\\/g,""),l,b,k,n,c);a.r[b].children.push(a.e);g=g[5];g!=i&&(g=m.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.Q(c+1).replace(/\\/g,"")+" "+g),this.M(a,a.e,c+1,g))}d=d.replace(f,"");g=RegExp("(?:^|\\s+)"+e+"\\s*(\\w\\S+)"+this.h.ja+"(?:\\s+(.*)|($))","m").exec(d);if(g!=i){l=m.trim(g[1]);n=k="";g[2]&&(n=m.trim(g[2]));if(g[3]){for(k=m.trim(g[3]);"{"===k.charAt(0);)k=k.substr(1);for(;"}"===k.charAt(k.length-1);)k=k.slice(0,
-1)}a.e++;a.r[a.e]=new o(a.e,e.replace(/\\/g,""),l,b,k,n,c);a.r[b].children.push(a.e);g=g[4];g!=i&&(g=m.trim(g),0<g.length&&isNaN(g.charAt(0))&&(g=this.Q(c+1).replace(/\\/g,"")+" "+g),this.M(a,a.e,c+1,g))}},Q:function(a){var b=Math.ceil(a/2).toString(),c="\\.";0==a%2&&(c="\\.\\.\\.");return b+c},Ja:function(){if(this.ka(this.b.fen)){for(var a=this.b.fen.split(" "),b=a[0].split("/"),c=112,d=0,e=0;8>e;e++){for(var f=d=0;8>f;f++){var g=b[e].charAt(d);if(g!=i&&isNaN(g)){var l=g.toLowerCase()==g?"b":"w";
this.a.position[c+f]=l+g.toLowerCase();"k"==g.toLowerCase()&&("w"==l?this.a.R=c+f:this.a.J=c+f)}else f+=+g-1;d++}c-=16}"b"==a[1]&&(this.a.f=-1)}},Qa:function(){this.i.empty();this.i.attr("tabindex",-1);0==this.s().size()&&this.i.append('<div class="board"></div>').css({position:"relative"});this.b.boardOnly||0==this.l().size()&&this.i.append('<div class="moves"></div>');0==this.S().size()&&this.i.append('<div class="controls"></div>');this.b.boardOnly||0==this.ca().size()&&this.i.append('<div class="notes"></div>');
var a=this.s(),b=this.q(),c=this.b.lightColor,d=this.b.darkColor,e,f;f="<table class='chess-replayer-board'>";for(var g=7;0<=g;g--){f+="<tr>";for(var l=0;7>=l;l++)e=0==(l+g)%2?d:c,f+="<td style='min-width: "+b+"px; width: "+b+"px; min-height: "+b+"px; height: "+b+"px; background-color: "+e+";'></td>";f+="</tr>"}f+="</table>";this.i.addClass("chess-replayer");a.html(f);this.S().html('<a class="start button" href="#">|< Start</a><a class="back button" href="#"><< Back</a><a class="flip button" href="#">Flip</a><a class="next button" href="#">Next >></a><a class="end button" href="#">End >|</a>')},
ma:function(){for(var a=this.q(),b=this.s(),c=this.O(),d=this.P(),e=7;0<=e;e--)for(var f=0;7>=f;f++){var g=16*e+f,l=this.a.position[g];if(l!=i){g=this.c.id+g;b.append("<div id='"+g+"' class='"+l+"-"+this.b.size+" chess-piece'></div>");var l=a*(7-e)+d,k=a*f+c;m("#"+g).css({position:"absolute",top:l,left:k,height:a+"px",width:a+"px"})}}},N:function(){var a=this.q(),b=this.s(),c=7*a,d=this.O(),e=this.P(),f,g,l,k;b.children(".chess-piece").each(function(){f=parseInt(m(this).css("top"),10)-e;g=parseInt(m(this).css("left"),
10)-d;k=c-g+d;l=c-f+e;m(this).css({position:"absolute",top:l,left:k})});this.d.direction*=-1},Ha:function(){var a=j;this.b.startFlipped&&(a=h);!("startFlipped"in this.Va)&&-1==this.a.f&&(a=h);a&&this.N()},Z:function(){for(;0<this.a.C;)this.A()},$:function(a){a=parseInt(a,10);if(a!=i&&a!=this.a.e){for(var b=[this.a.e],c=this.a.g[this.a.e];0<=c.m;)b.unshift(c.m),c=this.a.g[c.m];for(var d=[a],c=this.a.g[a];0<=c.m;)d.unshift(c.m),c=this.a.g[c.m];for(var c=0,e=Math.min(b.length,d.length),f=0;f<e&&b[f]==
d[f];f++)c=b[f];for(;this.a.e>c;)this.A();if(this.a.e!=a)for(;this.a.e<a;)this.L(d[f]),f++}},F:function(){this.$(this.a.g.length-1)},X:function(){for(var a=this.a.g[this.a.e];a!=i&&0<a.children.length;)a=a.children[a.children.length-1],this.L(a),a=this.a.g[a]},G:function(){var a=this.a.g[this.a.e];if(0==a.children.length)return j;if(1==a.children.length||this.d.n){var b=a.children[a.children.length-1];this.d.n&&(b=a.children[this.d.k],this.K());this.L(b)}else this.ua(a);return h},K:function(){this.d.n&&
(this.d.n=j,m(".modal li",this.c).unbind("click"),m(".modal",this.c).remove(),this.i.focus())},ua:function(a){for(var b=a.children.length,c="",c='<div class="modal"><ul>',d=b-1;0<=d;d--)c+='<li class="'+d+'">'+this.a.g[a.children[d]].o(h)+"</li>";this.s().append(c+"</ul></div>");a=8*this.q();m(".modal",this.c).css({top:10,left:a+20});var e=this;m(".modal li",this.c).click(function(a){a=parseInt(m(a.target).attr("class"),10);e.d.k=a;e.G()});this.d.n=h;this.d.k=b-1;this.d.W=b;m(".modal ."+this.d.k,
this.c).toggleClass("selected")},Ga:function(){this.d.k+1>=this.d.W||(this.d.k++,m(".modal .selected",this.c).toggleClass("selected"),m("."+this.d.k,".modal").toggleClass("selected"))},Fa:function(){0>=this.d.k||(this.d.k--,m(".modal .selected",this.c).toggleClass("selected"),m("."+this.d.k,".modal").toggleClass("selected"))},L:function(a){if(a!=i){var b=this.a.g[a];this.ia(b);this.T(b,1);this.a.C++;this.a.e=a;this.a.f*=-1}},A:function(){if(this.d.n)return this.K(),h;if(0<this.a.C){var a=this.a.g[this.a.e],
b=a.m;this.ia(this.a.g[b]);this.T(a,-1);this.a.C--;this.a.e=b;this.a.f*=-1;return h}return j},ia:function(a){this.Ua(a.ra);m(".active",this.c).toggleClass("active");var b=m("#"+this.c.id+"move"+a.H.toString());b.toggleClass("active");if(0<a.H){a=b.position().top;b=b.height();if(a<b){var c=b-a,d=this.l().scrollTop();d>c?this.l().scrollTop(d-c):0<d&&this.l().scrollTop(0)}a+b>this.l().height()&&(a=a+b-this.l().height(),this.l().scrollTop(this.l().scrollTop()+a))}},Ba:function(a){return"Q"==a||"R"==a||
"B"==a},ya:function(a){switch(a){case "Q":return this.w.Sa;case "R":return this.w.Ta;case "B":return this.w.na;case "N":return this.w.Da;case "K":return this.w.Ca}},va:function(a,b){for(var c=this.Ba(a),d=this.ya(a),e=(1==this.a.f?"w":"b")+a.toLowerCase(),f=[],g,l,k=0;k<d.length;k++){l=d[k];for(g=b+l;!(g&136);){if(this.a.position[g]!=i){this.a.position[g]==e&&f.push(g);break}g+=l;if(!c)break}}return f},xa:function(a){if(this.h.pa.test(a.move)){var a=1==this.a.f?0:7,b=16*a+4,a=16*a;return["m:"+b.toString()+
":"+(b-2).toString(),"m:"+a.toString()+":"+(a+3).toString()]}if(this.h.oa.test(a.move))return a=1==this.a.f?0:7,b=16*a+4,a=16*a+7,["m:"+b.toString()+":"+(b+2).toString(),"m:"+a.toString()+":"+(a-2).toString()];if(this.h.ga.test(a.move)){var b=this.h.ga.exec(a.move)[0],c=this.h.Ma.exec(a.move),d=c[3]-1,c=c[2].toLowerCase().charCodeAt(0)-97,d=16*d+c,c=this.va(b,d),b=[];if(1==c.length)b=["m:"+c[0]+":"+d];else{var e=this.h.Na.exec(a.move);if(e[1]!=i&&""!=e[1]){for(var f=[],g=e[1].toLowerCase().charCodeAt(0)-
97,a=0;a<c.length;a++)c[a]%16==g&&f.push(c[a]);c=f}if(e[2]!=i&&""!=e[2]){f=[];e=e[2]-1;for(a=0;a<c.length;a++)Math.floor(c[a]/16)==e&&f.push(c[a]);c=f}if(1==c.length)b=["m:"+c[0]+":"+d];else{e=[];f=1==this.a.f?this.a.R:this.a.J;for(a=0;a<c.length;a++)this.Aa(c[a],f)||e.push(c[a]);1==e.length&&(b=["m:"+e[0]+":"+d])}}this.a.position[d]!=i&&b.splice(0,0,"r:"+d+":"+this.a.position[d].toString())}else{e=c=d=i;b=[];f=1==this.a.f?"w":"b";if(this.h.ea.test(a.move))if(b=this.h.ea.exec(a.move),c=b[1].toLowerCase().charCodeAt(0)-
97,d=b[2]-1,b=d-1*this.a.f,b=16*b+c,this.a.position[b]==f+"p")e=b,b=["m:"+b+":"+(16*d+c).toString()];else{if(1==this.a.f){if(3==d&&"wp"==this.a.position[16+c]&&this.a.position[32+c]==i)return b=["m:"+(16+c).toString()+":"+(48+c).toString(),"e:"+c.toString()]}else if(4==d&&"bp"==this.a.position[96+c]&&this.a.position[80+c]==i)return b=["m:"+(96+c).toString()+":"+(64+c).toString(),"e:"+c.toString()];return[]}else if(this.h.da.test(a.move)){b=this.h.da.exec(a.move);c=b[2].toLowerCase().charCodeAt(0)-
97;d=b[3]-1;f=b[1].toLowerCase().charCodeAt(0)-97;b=d-1*this.a.f;if(this.a.z==c&&(e=i,1==this.a.f&&5==d&&(e=64+c),-1==this.a.f&&2==d&&(e=48+c),e!=i))return["r:"+e.toString()+":"+this.a.position[e],"m:"+(16*b+f).toString()+":"+(16*d+c).toString()];e=16*b+f;b=["r:"+(16*d+c).toString()+":"+this.a.position[16*d+c],"m:"+(16*b+f).toString()+":"+(16*d+c).toString()]}if(this.h.fa.test(a.move)){f=this.h.fa.exec(a.move)[1];g=1==this.a.f?"w":"b";d=(16*d+c).toString();c=[];for(a=0;a<b.length;a++)"m"!=b[a].split(":")[0]&&
c.push(b[a]);c.push("p:"+d+":"+e.toString()+":"+g+":"+f.toLowerCase());b=c}}return b},Aa:function(a,b){var c=a-b,d=Math.abs(c),e=i;0<d&&7>d?e=1:0==d%15?e=15:0==d%16?e=16:0==d%17&&(e=17);if(e!==i){d=e;0>c&&(e*=-1);for(var c=b+e,f=j;!(c&136);){if(this.a.position[c]!=i)if(c==a)f=h;else{if(f){e=this.a.position[c];c=e.charAt(1);if(e.charAt(0)!=(1==this.a.f?"b":"w"))break;return 15==d||17==d?"q"==c||"b"==c:"r"==c||"q"==c}break}c+=e}}return j},T:function(a,b){if(0<b){if(a.j==i||0==a.j.length){var c=this.xa(a);
this.a.g[a.H].j=c;a.j=c}this.a.z="";for(c=0;c<a.j.length;c++){var d=a.j[c],d=d.split(":");switch(d[0]){case "m":this.Y(d[1],d[2]);break;case "a":this.B(d[1],d[2]);break;case "r":this.I(d[1]);break;case "e":this.a.z=d[1];break;case "p":this.I(d[2]),this.B(d[1],d[3]+d[4])}}}else if(0>b){if(a.j==i)return j;d=this.a.g[a.m];if(d!=i&&d.j!=i){for(var e=j,c=0;c<d.j.length;c++)"e"==d.j[c].charAt(0)&&(e=h,this.a.z=parseInt(d.j[c].charAt(2),8));e||(this.a.z="")}for(c=a.j.length-1;0<=c;c--)switch(d=a.j[c],d=
d.split(":"),d[0]){case "m":this.Y(d[2],d[1]);break;case "a":this.I(d[1]);break;case "r":this.B(d[1],d[2]);break;case "p":this.I(d[1]),this.B(d[2],d[3]+"p")}}},B:function(a,b){var c=this.c.id+a;this.s().append("<div id='"+c+"' class='"+b+"-"+this.b.size+" chess-piece'></div>");var d=this.q(),e=Math.floor(a/16),f=a%16;-1==this.d.direction?e=7-e:f=7-f;e=d*e+this.P();f=d*f+this.O();m("#"+c).css({position:"absolute",top:e,left:f,height:d+"px",width:d+"px"});this.a.position[a]=b},I:function(a){m("#"+(this.c.id+
a)).remove();this.a.position[a]=i},Y:function(a,b){var c=this.c.id+a,d=this.c.id+b,e=this.q(),f=(Math.floor(b/16)-Math.floor(a/16))*e*this.d.direction,e=(a%16-b%16)*e*this.d.direction;m("#"+c).animate({top:"+="+f+"px",left:"+="+e+"px"},"fast");m("#"+c).attr("id",d);c=this.a.position[a];this.a.position[b]=c;this.a.position[a]=i;"wk"===c&&(this.a.R=b);"bk"===c&&(this.a.J=b)}};p.D=p.prototype.D;m.fn.ha=function(a){return this.each(function(){(new p(this,a)).za()})};jQuery.prototype.replayer=m.fn.ha;
m.fn.ha.defaults=p.D;})()